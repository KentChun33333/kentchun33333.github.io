<!doctype html>
<html lang="en">
<head>
    <link href='https://fonts.googleapis.com/css?family=Caveat' rel='stylesheet'>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Stock Prediction with LorenzANN | Autumn Memo</title>
    <meta property="og:title" content="Stock Prediction with LorenzANN - Autumn Memo">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2023-03-24T00:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2023-03-24T00:00:00&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="Stock Prediction with LorenzANN">
        <meta name="author" content="Kent Chiu">
        


    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8949849444403982"
    crossorigin="anonymous"></script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PZF7WLJRQL"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-PZF7WLJRQL');
    </script>
    <meta property="og:url" content="https://kentchun33333.github.io/post/customized-lorenz-ann-classification/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    <script data-ad-client="ca-pub-5108790028230107" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://kentchun33333.github.io">
                        Autumn Memo
                    </a>
                
                <p class="description">A place of a investment, algorithm and Life flavor.</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    
                    
                    
                    <a  href="https://kentchun33333.github.io/post/" title="Main">Main</a>
                    
                    <a  href="https://kentchun33333.github.io/archives/" title="Archives">Archives</a>
                    
                    <a  href="https://kentchun33333.github.io/about/" title="About">About</a>
                    
                    <a  href="https://kentchun33333.github.io" title=""></a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Stock Prediction with LorenzANN</h1>
        </header>
        <date class="post-meta meta-date">
            2023 - 3 - 24 
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/algorithm'>Algorithm</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    Reading </span></span>
        </div>
        
        
        <div class="post-content">
            <h2 id="introduction">Introduction</h2>
<p>
        <img class="mx-auto" alt="" src="/img/2023-03-26-20-12-40-image.png" />   
    </p>
<p>LorenzANN, the algorithm of <strong>Approximate Nearest Neighbors Search with Lorentzian Distance</strong>, has gained popularity as a customized machine learning tool. Some youtubers even consider it to be one of the best machine learning indicators available.</p>
<h2 id="core-method">Core Method</h2>
<p>The cusomized LorenzANN algorithm uses the following methodology:</p>
<ol>
<li>
<p>The algorithm maintains a list of the k-similar neighbors simultaneously in both a predictions array and a corresponding distances array.</p>
</li>
<li>
<p>If the predictions array size exceeds the number of nearest neighbors specified in settings.neighborsCount, the algorithm removes the first neighbor from both the predictions array and the corresponding distances array.</p>
</li>
<li>
<p>The lastDistance variable is overridden to be a distance in the lower 25% of the array. This step helps to increase accuracy by ensuring that newly added distance values increase at a slower rate.</p>
</li>
<li>
<p>Lorentzian distance is used as a distance metric, which minimizes the effect of outliers and takes into account the warping of &ldquo;price-time&rdquo; due to proximity to significant economic events.</p>
</li>
</ol>
<h2 id="python-example">Python Example</h2>
<p>While the source code for LorenzANN is shared on TradingView, there are certain limitations to its use. Firstly, the algorithm is hard-coded with fixed inputs and can only handle a maximum of five features. Additionally, it is written in Pine-Script, which embeds the core logic with visualization logics, making it difficult to separate the two functionalities.</p>
<p>To overcome the limitations of the LorenzANN algorithm, I have translated the code shared on TradingView from Pine-Script to Python. The translated code is now capable of handling any number of features, making it more flexible than the original version. This updated algorithm has been successfully integrated into my trading bot, allowing me to utilize its enhanced capabilities for my trading strategies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">approximate_nearest_neighbors</span>(df, y_col, x_cols, sampling_factor<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>, neighber_count<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>, look_back_period<span style="color:#f92672">=</span><span style="color:#ae81ff">80</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    1. The algorithm iterates through the dataset (df) in chronological order, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    using the modulo operator to only perform calculations every sampling_factor bars, where sampling_factor= 4. 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    2. This serves the dual purpose of reducing the computational overhead of the algorithm 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        and ensuring a minimum chronological spacing between the neighbors of at least sampling_factor bars, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        where sampling_factor = 4. 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    3. A list of the k-similar neighbors is simultaneously maintained in both 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    a predictions array and corresponding distances array. 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    When the size of the predictions array exceeds the desired number of nearest 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    neighbors specified in neighber_count, where neighber_count=8, 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    the algorithm removes the first neighbor from the predictions array 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    and the corresponding distance array.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    4. The lastDistance variable is overriden to be a distance in the lower 25</span><span style="color:#e6db74">% o</span><span style="color:#e6db74">f the array. 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This step helps to boost overall accuracy by ensuring subsequent newly added distance values increase at a slower rate.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> len(df)<span style="color:#f92672">&gt;</span> look_back_period
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> [<span style="color:#66d9ef">None</span>]<span style="color:#f92672">*</span> look_back_period
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> tqdm(range(look_back_period, len(df))):
</span></span><span style="display:flex;"><span>        row <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>iloc[i]
</span></span><span style="display:flex;"><span>        predictions <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        distances <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        last_dist <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> pre_i <span style="color:#f92672">in</span> range(i<span style="color:#f92672">-</span>look_back_period, i):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># sampling</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> pre_i <span style="color:#f92672">%</span> sampling_factor <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                pre_row <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>iloc[pre_i]
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Calculate Lorentzian distance and add to distances array</span>
</span></span><span style="display:flex;"><span>                distance <span style="color:#f92672">=</span> lorentzian_distance(row[x_cols]<span style="color:#f92672">.</span>values, pre_row[x_cols]<span style="color:#f92672">.</span>values)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> distance <span style="color:#f92672">&gt;</span> last_dist:
</span></span><span style="display:flex;"><span>                    distances<span style="color:#f92672">.</span>append(distance)
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># Add prediction to predictions array</span>
</span></span><span style="display:flex;"><span>                    predictions<span style="color:#f92672">.</span>append(np<span style="color:#f92672">.</span>round(df[y_col]<span style="color:#f92672">.</span>iloc[i]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># If number of neighbors is greater than neighber_count, remove the first neighbor</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> len(predictions) <span style="color:#f92672">&gt;</span> neighber_count:
</span></span><span style="display:flex;"><span>                    predictions <span style="color:#f92672">=</span> predictions[<span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>                    distances <span style="color:#f92672">=</span> distances[<span style="color:#ae81ff">1</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Override last_dist to be a distance in the lower 25% of the array</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># this is like the time-decay factor </span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> distances:
</span></span><span style="display:flex;"><span>                    last_dist <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>percentile(distances, <span style="color:#ae81ff">25</span>)
</span></span><span style="display:flex;"><span>        res<span style="color:#f92672">.</span>append(np<span style="color:#f92672">.</span>mean(predictions))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> res
</span></span></code></pre></div><p>Notice that the result will be different on TradingView since the overall shared trading stratgy also including some technical filters like golden cross with 200 EMA/SME &hellip; etc.</p>
<h2 id="summary">Summary</h2>
<p>Overall, the method with some technical indicators as input did show some profitable experiment during the backtesting. For example as below backtesting reuslt.</p>
<p><strong>Simulation Result</strong>
        <img class="mx-auto" alt="" src="/img/2023-03-26-20-48-45-image.png" />   
    </p>
<p><strong>Key Statistic</strong></p>
<table>
<thead>
<tr>
<th>Item</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Back Test Start</td>
<td>2023-01-03</td>
</tr>
<tr>
<td>Back Test End</td>
<td>2023-03-24</td>
</tr>
<tr>
<td>Back Test Cash</td>
<td>29000</td>
</tr>
<tr>
<td>Frequency</td>
<td>15 min</td>
</tr>
<tr>
<td>Sharp-Ratio</td>
<td>1.7</td>
</tr>
<tr>
<td>max_drawdown</td>
<td>3102</td>
</tr>
<tr>
<td>return_value</td>
<td>9042</td>
</tr>
<tr>
<td>return_to_mdd_ration</td>
<td>2.91</td>
</tr>
<tr>
<td>return_per_day</td>
<td>113</td>
</tr>
</tbody>
</table>
<h3 id="reference">Reference</h3>
<p><a href="https://www.tradingview.com/script/WhBzgfDu-Machine-Learning-Lorentzian-Classification/#:~:text=A%20Lorentzian%20Distance%20Classifier%20(%20LDC,a%20multi%2Ddimensional%20feature%20space">https://www.tradingview.com/script/WhBzgfDu-Machine-Learning-Lorentzian-Classification/#:~:text=A%20Lorentzian%20Distance%20Classifier%20(%20LDC,a%20multi%2Ddimensional%20feature%20space</a>.</p>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing" >
        
        <li><a href="/post/cblof/">Cluster-Based Local Outlier Factor</a></li>
        
        <li><a href="/post/db-index-vs-silhouette-score/">Metric for hyperparamter search in Unsupervise Learning</a></li>
        
        <li><a href="/post/self-instruct-aligning-language-model-with-self-generated-instructions/">Paper Summay on Aligning LLM with Self-Instruct</a></li>
        
        <li><a href="/post/tradingtactic/">Trading Strategy</a></li>
        
        <li><a href="/post/what-is-rouge-l/">Recall-Oriented Understudy for Gisting Evaluation (ROUGE)</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/algotrading'>AlgoTrading</a></li>
                
                <li><a href='/tags/unsupervise-learning'>Unsupervise Learning</a></li>
                
                <li><a href='/tags/ai'>AI</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "KentChun33333/kentchun33333.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2023 <a href="https://kentchun33333.github.io">Autumn Memo By Kent Chiu</a>
        
    </div>
    <br />

    <div>
       
        <div class="github-badge">
            <a href="https://kentchun33333.github.io/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value  bg-blue"> Kent Chiu </span></a>
        </div>

        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Powered by</span><span class="badge-value bg-yellowgreen"> Maupassant-Hugo</span></a>
        </div>

    </div>
    
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>





                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://kentchun33333.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://kentchun33333.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>Categories</a></h3>
<ul class="widget-list">
    
    <li><a href="https://kentchun33333.github.io/categories/algorithm/">Algorithm (7)</a></li>
    
    <li><a href="https://kentchun33333.github.io/categories/communication/">Communication (1)</a></li>
    
    <li><a href="https://kentchun33333.github.io/categories/design-life/">Design Life (2)</a></li>
    
    <li><a href="https://kentchun33333.github.io/categories/software/">Software (3)</a></li>
    
    <li><a href="https://kentchun33333.github.io/categories/trading/">Trading (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>Tags</a></h3>
<div class="tagcloud">
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/ai/">AI</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/algotrading/">AlgoTrading</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/chatgpt/">ChatGPT</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/environment/">Environment</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/equitytrading/">EquityTrading</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/github-project/">Github Project</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/hugo/">HUGO</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/inverted-index/">Inverted Index</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/investment/">Investment</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/large-language-model/">Large Language Model</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/metric/">Metric</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/nlp/">NLP</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/paper-summary/">Paper Summary</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/project-management/">Project Management</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/scrum/">SCRUM</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/search-system/">Search System</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/typora/">Typora</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/uncertainty-estimation/">Uncertainty Estimation</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/unsupervise-learning/">Unsupervise Learning</a>
    </div>
    
    <div class="post-meta">
        <a class="simple-meta-tag" href="https://kentchun33333.github.io/tags/workflow/">Workflow</a>
    </div>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">Others</h3>
        <ul class="widget-list">
            <li><a href="https://kentchun33333.github.io/index.xml">RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>